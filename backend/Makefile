.PHONY: help build run dev test install-deps lint migrate-up migrate-down migrate-create docker-build docker-run clean

help:
	@echo "=== Rosa Mexicano API - Makefile ==="
	@echo ""
	@echo "Available commands:"
	@echo "  make install-deps    Install Go dependencies"
	@echo "  make build           Build the application"
	@echo "  make run             Run the application"
	@echo "  make dev             Run with hot reload (requires air)"
	@echo "  make test            Run tests"
	@echo "  make lint            Run linter"
	@echo "  make migrate-up      Run database migrations up"
	@echo "  make migrate-down    Rollback database migrations"
	@echo "  make migrate-create  Create new migration (use: make migrate-create name=migration_name)"
	@echo "  make docker-build    Build Docker image"
	@echo "  make docker-run      Run Docker container"
	@echo "  make clean           Clean build artifacts"
	@echo ""

install-deps:
	@echo "ğŸ“¦ Installing Go dependencies..."
	go mod download
	go mod tidy
	@echo "âœ“ Dependencies installed"

build:
	@echo "ğŸ”¨ Building application..."
	go build -o bin/server cmd/server/main.go
	@echo "âœ“ Build complete: bin/server"

run: build
	@echo "ğŸš€ Running application..."
	./bin/server

dev:
	@echo "ğŸ”„ Running with hot reload..."
	@command -v air > /dev/null || go install github.com/cosmtrek/air@latest
	air

test:
	@echo "ğŸ§ª Running tests..."
	go test -v ./...

lint:
	@echo "ğŸ“‹ Running linter..."
	@command -v golangci-lint > /dev/null || go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	golangci-lint run ./...

migrate-up:
	@echo "â¬†ï¸  Running migrations up..."
	@command -v migrate > /dev/null || (echo "migrate-tool not found. Install: https://github.com/golang-migrate/migrate" && exit 1)
	migrate -path internal/database/migrations -database "$(DATABASE_URL)" up

migrate-down:
	@echo "â¬‡ï¸  Rolling back migrations..."
	@command -v migrate > /dev/null || (echo "migrate-tool not found. Install: https://github.com/golang-migrate/migrate" && exit 1)
	migrate -path internal/database/migrations -database "$(DATABASE_URL)" down

migrate-create:
	@if [ -z "$(name)" ]; then \
		echo "Error: Please provide migration name with 'name=migration_name'"; \
		exit 1; \
	fi
	@echo "ğŸ“ Creating migration: $(name)"
	@command -v migrate > /dev/null || (echo "migrate-tool not found. Install: https://github.com/golang-migrate/migrate" && exit 1)
	migrate create -ext sql -dir internal/database/migrations -seq $(name)

docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t rosa-mexicano-api:latest .
	@echo "âœ“ Docker image built"

docker-run:
	@echo "ğŸ³ Running Docker container..."
	docker run -p 8080:8080 --env-file .env rosa-mexicano-api:latest

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf bin/
	go clean
	@echo "âœ“ Clean complete"

.DEFAULT_GOAL := help
